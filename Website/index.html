<!DOCTYPE html>
<html>

<head>
    <script src='/js/d3.min.js'></script>
    <script>
    d3.selection.prototype.union = function(that) {
        if (that instanceof d3.selection) {
            var newselection = d3.select(null); //ensure the correct prototype
            newselection.splice(0, 1); //empty the selection      
            [].push.apply(newselection, this); //push in this selection, without loosing the prototype 
            [].push.apply(newselection, that); //push in that selection, without loosing the prototype
            return newselection;
        } else {
            throw new Error("Can only union with another d3 selection");
        }
    };
    </script>
    <link rel='stylesheet' type='text/css' href='/css/styles.css'>
</head>

<body>
    <div class='horizontal-bar-comparison'>
    </div>
    <script>
    var title = 'Data set';
    var data = [{
        title: "ABC",
        values: [0, 6]
    }, {
        title: "B",
        values: [1, 5]
    }, {
        title: "C",
        values: [2, 10]
    }];

    var createHorizontalBarComparison = function(parent, title, data) {
        var margins = {
            top: 10,
            bottom: 10,
            sides: 10,
        };
        var titleHeight = 60;

        var centerOffset = 20 * d3.max(data.map(function(d) {
            return d.title.length;
        })) + 20;
        var barHeight = 40;
        var barSpacing = 10;
        // Below this size, the value text will render outside the box
        var minimumBarSize = 20;

        var width = 640 + 2 * margins.sides;
        var height = margins.top + titleHeight + data.length * barHeight - barSpacing + margins.bottom;

        var halfWidth = width / 2;
        var xScale = d3.scale.linear()
            .domain([0, d3.max(data.map(function(d) {
                return d3.max(d.values);
            }))])
            .range([0, halfWidth - centerOffset - margins.sides]);

        var chart = parent.append('svg')
            .classed('chart', true)
            .attr("width", width)
            .attr("height", height)
            .append("g")
            .attr("transform", "translate(0," + margins.top + ")");
        chart.append('text')
            .classed('title', true)
            .attr('x', halfWidth)
            .attr('y', 50)
            .style('text-anchor', 'middle')
            .text(title);

        var chartArea = chart.append("g")
            .attr("transform", 'translate(0, ' + titleHeight + ')');

        var row = chartArea.selectAll("g")
            .data(data)
            .enter()
            .append("g")
            .attr('transform', function(d, i) {
                return 'translate(0, ' + barHeight * i + ')';
            });
        row.append("rect")
            .classed("row", true)
            .attr("width", width)
            .attr("height", barHeight);
        var rowLabel = row.append('text')
            .classed('category-label', true)
            .attr("x", halfWidth)
            .attr('y', barHeight / 2)
            .attr("dy", ".35em")
            .text(function(d) {
                return d.title;
            });
        var leftBar = row
            .append("rect")
            .classed('bar-left', true)
            .classed('emphasis', function(d) {
                return d.values[0] >= d.values[1];
            })
            .attr('x', function(d) {
                return halfWidth - xScale(d.values[0]) - centerOffset;
            })
            .attr('width', function(d) {
                return xScale(d.values[0]);
            });
        var rightBar = row
            .append("rect")
            .classed('bar-right', true)
            .classed('emphasis', function(d) {
                return d.values[1] >= d.values[0];
            })
            .attr('x', halfWidth + centerOffset)
            .attr('width', function(d) {
                return xScale(d.values[1]);
            });
        var bars = leftBar.union(rightBar)
            .classed('bar', true)
            .attr('height', barHeight - barSpacing)
            .attr('y', barSpacing / 2);
        var leftValueText = row.append('text')
            .attr('x', function(d) {
                return halfWidth - xScale(d.values[0]) - centerOffset;
            })
            .attr('dx', function(d) {
                return xScale(d.values[0]) > minimumBarSize ? 5 : -5;
            })
            .style('text-anchor', function(d) {
                return xScale(d.values[0]) > minimumBarSize ? 'begin' : 'end';
            })
            .text(function(d) {
                return d.values[0];
            });
        var rightValueText = row.append('text')
            .attr('x', function(d) {
                return halfWidth + xScale(d.values[1]) + centerOffset;
            })
            .attr('dx', function(d) {
                return xScale(d.values[1]) > minimumBarSize ? -5 : 5;
            })
            .style('text-anchor', function(d) {
                return xScale(d.values[1]) > minimumBarSize ? 'end' : 'begin';
            })
            .text(function(d) {
                return d.values[1];
            });
        var valueText = leftValueText.union(rightValueText)
            .attr('y', barHeight / 2 + barSpacing)
            .attr('dy', -5);
    }

    createHorizontalBarComparison(d3.select('.horizontal-bar-comparison'), title, data);
    </script>
</body>

</html>
