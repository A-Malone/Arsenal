--- ---
<!DOCTYPE html>
<html>

<head>
    <script src='/js/d3.min.js'></script>
    <link rel='stylesheet' type='text/css' href='/css/force.css'>
</head>

<body>
    <script>
    var createForce = function(parent) {
        var graph = {
            nodes: [{
                itemId: 0,
                "group": 1,
                frequency: 1
            }, {
                itemId: 1,
                "group": 2,
                frequency: 1
            }, {
                itemId: 2,
                "group": 1,
                frequency: 5
            }, {
                itemId: 3,
                "group": 1,
                frequency: 1
            }, {
                itemId: 4,
                "group": 1,
                frequency: 1
            }, ],
            links: [{
                "source": 1,
                "target": 0,
                "value": 10
            }, {
                "source": 2,
                "target": 0,
                "value": 8
            }, {
                "source": 3,
                "target": 0,
                "value": 10
            }, {
                "source": 3,
                "target": 2,
                "value": 6
            }, {
                "source": 4,
                "target": 0,
                "value": 1
            }, ]
        };

        var width = 640;
        var height = 480;

        var svg = parent.append("svg")
            .attr("width", width)
            .attr("height", height);

        var color = d3.scale.category20();
        var nodes = graph.nodes.slice(),
            links = [],
            bilinks = [];
        graph.links.forEach(function(link) {
            var s = nodes[link.source],
                t = nodes[link.target],
                i = {
                    invisible: true
                }, // intermediate node
                v = link.value;
            nodes.push(i);
            links.push({
                source: s,
                target: i,
                value: v
            }, {
                source: i,
                target: t,
                value: v
            });
            bilinks.push([s, i, t, v]);
        });
        var strengthScale = d3.scale.linear()
            .domain([0, d3.max(graph.links.map(function(l) {
                return l.value;
            }))])
            .range([0, 1]);


        var update = function() {
            var force = d3.layout.force();
            force
                .nodes(nodes)
                .links(links);
            force.charge(function(n) {
                    if (n.invisible) {
                        return -100;
                    }
                    return -1000;
                })
                .friction(0.5)
                .size([width, height])
                .linkDistance(function(l) {
                    return strengthScale(l.value) * 100;
                })
                .linkStrength(function(l) {
                    return strengthScale(l.value);
                });

            var linkUpdate = svg.selectAll(".link")
                .data(bilinks);
            var link = linkUpdate
                .enter()
                .append("path")
                .attr("class", "link")
                .attr('stroke-width', function(l) {
                    return l[3];
                });
            linkUpdate.exit()
                .transition()
                .attr('stroke-width', 0)
                .remove();

            var nodeUpdate = svg.selectAll(".node")
                .data(graph.nodes);
            var node = nodeUpdate
                .enter()
                .append("g")
                .attr("class", function() {
                    return 'node';
                })
                .on('click', function(n) {
                    nodes.forEach(function(aNode) {
                        aNode.fixed = false
                    })
                    n.fixed = true;
                    update();
                })
                .call(force.drag);
            nodeUpdate.exit()
                .select('g')
                .transition()
                .remove();
            node.append('circle')
                .attr("r", function(d) {
                    return d.frequency * 6;
                })
                .style("fill", function(d) {
                    return color(d.group);
                });
            nodeUpdate.exit()
                .select('g circle')
                .transition()
                .attr('r', 0)
                .remove();
            node.append('defs')
                .append('clipPath')
                .attr('id', function(d, i) {
                    return 'circle' + i;
                })
                .append('circle')
                .attr('r', function(d) {
                    return d.frequency * 5;
                });
            nodeUpdate.exit()
                .select('g defs clipPath circle')
                .transition()
                .attr('r', function() {
                    console.log('exitting');
                    return 0;
                })
                .remove();
            node.append('image')
                .attr('width', function(d) {
                    return d.frequency * 10;
                })
                .attr('height', function(d) {
                    return d.frequency * 10;
                })
                .attr('x', function() {
                    return -d3.select(this).attr('width') / 2;
                })
                .attr('y', function() {
                    return -d3.select(this).attr('height') / 2;
                })
                .attr('clip-path', function(d, i) {
                    return 'url(#circle' + i + ')';
                })
                .attr('xlink:href', 'http://ddragon.leagueoflegends.com/cdn/5.2.1/img/item/1001.png');
            nodeUpdate.exit()
                .select('g image')
                .transition()
                .remove();

            force
                .on("tick", function() {
                    link.attr("d", function(d) {
                        return "M" + d[0].x + "," + d[0].y + "S" + d[1].x + "," + d[1].y + " " + d[2].x + "," + d[2].y;
                    });
                    node.attr("transform", function(d) {
                        return "translate(" + d.x + "," + d.y + ")";
                    });
                });

            force.start();
        };
        update();
    };

    d3.select('body').call(createForce);
    </script>
</body>

</html>
